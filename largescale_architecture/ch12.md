# Ch12 Mind of Scalablity secure

### 계층과 확장성

#### 확장성에 대한 요구

- 상당수의 서비스가 서버 1대로 동작
- 한 서비스에 수억 트래픽이 발생하면 어떻게 해서 확장시켜 갈 것인가라는 과제

#### 계층별 확장성

- AP서버는 기본적으로 간단하게 확장가능 
- AP서버는 무상태로 존재 -> 요청 별 AP서버로 날려보내도 처리상 문제가 미발생 -> 대수만 늘리면 된다.

- DB나 파일 서버의 경우에는 분산, 확장성 확보가 어려움  
- Read, write 두 종류의 요청이 있는데 read는 비교적 확장, 분산이 쉽고 write를 분산하는 것은 어려움


#### 해결 방법

1. 엑세스 패턴에 따른 분산(국소성을 이용한다)
2. 요청패턴을 ‘섬’으로 분할 (요청 패턴에 따라서 AP, DB를 전체로 묶어서 분산한다)
3. DB서버를 Master-slave로 나누어서 Master는 write, slave는 read를 담당 / write후 데이터를 동기화.

### 부하 파악, 튜닝

#### 부하 파악

- 확장을 검토하기 위해서는 서버 부하를 파악 필요 -> 각 서버 부하를 관리 및 시각화

#### 부하를 측정하기 위한 항목

- Load Average 측정 프로세스는 상시 측정 가능 
    - CPU를 할당 받지 않아서 대기하고 있는 프로세스의 평균치
    - 메모리 사용처에 관해서는 사용자 공간이 소비되고 있는 메모리나 공유되고 있는 메모리
    - 커널이 사용하고 있는 버퍼의 메모리 등

#### 용도에 맞는 튜닝 – 사용자용 서버, 봇용 서버
- ‘하테나’에서는 사용자, 봇용으로 AP서버를 나눈다 
    - 봇용 서버는 응답시간이 그다지 중요하지 않으므로 요청 처리 수를 최대화시키는 방향 -> Load Average도 높게 나타남 
    - 시용자용 서버는 사용자의 활동에 따라 부하가 변동하고 트래픽에 따라 부하가 변동 
        - 심야 시간대에는 떨어지고 낮에는 높고 밤에는 피크 시간대에 더 높게 나타나는 경향
        - 사용자용 서버는 양호한 응답을 유지하는 방향으로 튜닝

- AP서버를 분리함에 따라 튜닝 정책을 변경 필요 
    - 효율을 중시 
    - 응답시간을 중시 
    - 리소스를 최대한 사용하는 것을 중시

- AP 서버/DB 서버의 튜닝 정책과 서버 대수
    
- DB
    - 응답을 중시
    - 리소스를 소진하는 방법

#### 서비스 규모와 튜닝
    - 서버 대수가 늘어났을 때 비정상적인 거동을 하고 있는 서버를 찾을 수 있는 방법 알아내기 -> “30대 중 1대에 이상이 발생했을 때 해당 서버를 어떻게 파악할 수 있을까”가 과제다.

##### 튜닝

- 부하 파악 -> 자체제작 서버 관리 툴
- 상태 감시 -> 부하를 가시화해서 병목이나 이상현상을 빠르게 파악할 수 있도록 한다.

#### 확장성 확보
- 확장성 확보를 위해 로드밸런서를 이용하거나 파티셔닝(DB분할) 진행 
- ‘하테나’에서는 LVS라는 Linux 커널에 포함되어 잇는 로드밸런서를 사용하고 있다.
