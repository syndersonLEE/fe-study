# Ch12 System Stable

### 다중성 확보

- SPOF(Single Point of Failure)단일 장애점을 제거하는 것


#### 다중성 확보 - AP서버

AP서버에서의 확장성을 생각하는 방식과 마찬가지로 서버 여러 대를 늘어놓는 게 기본
    -  1, 2대 정도 정지하더라도 충분히 처리할 수 있도록 처리능력을 확보해두는 것이다. 서버는 다양한 이유로 멈춤 
        - 이에 대한 대응으로 로드밸런서로 페일오버(장애극복), 페일백(정상복귀)하여 고장 난 서버를 자동적으로 분리 -> 서버가 복구되면 원상태로 복귀시키는 작업
        - 로드밸런서는 서버에 대해 주기적으로 헬스체크 / AP서버나 DB서버가 살아있는지 여부를 판정

#### 다중성 확보 - DB서버

DB서버도 마찬가지로 여러 대 나열해서 1, 2대 정도 정지하더라도 충분한 처리능력이 있도록 하는 것 
    - Master의 다중화 수행
        - ‘하테나’에서는 MySQL의 멀티 마스터 사용 -> 서로가 서로의 슬레이브가 되는 상태 / 쓰기작업 시 복제하는 형태 
        - 엔터프라이즈의 경우에는 동기적으로 처리함으로써 대처 / 반대편에 정확히 다 쓰인 이후에 클라이언트에 결과를 반환

### 오라클 RAC(real application cluster)

- RAC란 여러 인스턴스에서 하나의 DB로 연결
- 하나에서 문제가 발생한 경우 다른 인스턴스로 연결
- 캐시를 이용해서 데이터의 정합성이 유지

#### 다중성 확보 – 스토리지 서버

- ‘하테나’에서는 이미지 파일과 같은 미디어 파일을 저장하기 위한 분산 스토리지 서버로 MogileFS를 사용
- 대량의 파일을 보존할 수 있는 확장성과 일부 서버가 다운되더라도 정체 장애가 되지 않도록 다중성을 확보
- 메타데이터와 파일데이터를 각각 관리해주는 방식
- 1대당 용량을 너무 높이게 되면 그 안에 저장된 파일수가 너무 많아져서 읽기나 쓰기 I/O 성능이 병목이 되어 100% 용량을 다 사용할 수 없게 되는 경우도 발생

### 시스템 안정화
계
- 안정성과 자원효율 그리고 응답속도 간에는 상반관계


### 시스템의 불안정 요인

1. 기능추가, 메모리 누수
    - 새로운 기능을 추가하면 그 기능이 예상보다 무거워서 전체적인 부하가 늘어나 서비스가 다운되는 일이 발생 / 메모리 누수 발생 위험

2. 지뢰
    - 특정 URL이 읽히면 아무리 시간이 지나도 응답이 오지 않아서 장애의 원인이 되는 현상 / 무한루프에 빠지거나 메모리를 비정상적으로 소비하면서 폭주해서 시스템의 불안정으로 이어짐 

3. 사용자의 액세스 패턴
    - 캐시를 반환으로 해결

4. 데이터 증가
    - 당초 예상했던 데이터보다 늘어나서 이것이 전체적인 부하의 증가로 이어져서 시스템이 불안정해지는 경우 -> DB설계를 변경하거나 데이터를 압축

5. 외부연계 추가
    - 광고 관련 웹 PAI나 Amazon 웹 API 등을 새롭게 추가하는 등 외부의 새로운 API를 연결 -> 외부시스템이 다운되어 있을 때 덩달아서 다운되는 형태가 되기 쉬움
 
6. 메모리, HDD장애, NIC장애
    - 메모리나 HDD, 네트워크 장애는 일상적으로 발생 -> 로드밸런서에서 적절한 항목에 대해 헬스체크를 통한 서킷 브레이킹 
 
### 시스템 안정화 대책

- 실제 안정화 대책 – 적절한 버퍼 유지와 불안정 요인 제거

- 시스템 수용능력의 7할을 상한선으로 해서 이를 넘어서면 서버를 추가하거나 메모리를 늘리는 등 임계치를 설정
    1. SQL 부하대책
    2. 메모리 누수 줄이기
    3. 비정상 동작 시 자율제어를 들 수 있다.

### 이상 동작시 자율 제어

1. 자동 DoS판정 ->특정 IP로부터 다수의 요청이 오면 당분간 403을 반환해서 액세스를 차단
2. 자동 재시작 -> 메모리 누수로 인해 스왑을 사용하기 시작하면서 부하가 증가하여 성능이 떨어질 때,  어느 정도 리소스를 지나치게 사용했다 고 판단했다면 웹 서버를 재시작
3. 자동 쿼리제거 -> DB 서버에 어떤 쿼리가 실행되고 있는지를 파악해서 어느 정도 이상으로 시간이 경과한 쿼리를 강제적으로 KILL하는 것

자율적으로 안정화하는 방향으로 시스템을 제어필요 -> 근본적 대책 X